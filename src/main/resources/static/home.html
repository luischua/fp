<!doctype html>
<html lang="en">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<head>
    <!-- Add Bootstrap and Bootstrap-Vue CSS to the <head> section -->
    <link type="text/css" rel="stylesheet" href="https://unpkg.com/bootstrap/dist/css/bootstrap.min.css"/>
    <link type="text/css" rel="stylesheet" href="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.min.css"/>
</head>
<body>
    <div id="app">
        <!-- Info modal -->
        <b-modal :id="infoModal.id" :title="infoModal.title" ok-only @hide="resetInfoModal">
            <pre>{{ infoModal.content }}</pre>
        </b-modal>
        <datalist id="customerSelect">
            <option v-for="c in customerDataList">{{c.name}}</option>
        </datalist>
        <datalist id="productSelect">
            <option v-for="c in productDataList">{{c.name}}</option>
        </datalist>
        <b-alert :show="dismissCountDown" dismissible fade variant="success" @dismiss-count-down="countDownChanged">
            Save Successful. Alert will dismiss after {{ dismissCountDown }} seconds...
        </b-alert>
        <b-card no-body>
            <b-tabs pills card vertical>
                <b-tab title="Customer" active>
                    <b-button @click="newFormGeneric(customerForm, defaultCustomerValues, 'bv-modal-customer')">New</b-button>
                    <b-button @click="refresh('customerTable')">Refresh Table</b-button>
                    <b-modal ref="bv-modal-customer" hide-footer>
                        <b-alert variant="danger" :show="showErrorAlert">{{ errorMessage }}</b-alert>
                        <b-alert variant="danger" :show="showErrorDetail">
                            <div>System Error</div>
                            <b-button :pressed.sync="showStackTrace" variant="primary">
                                {{ showStackTrace ? 'Hide' : 'Show' }} Error Details
                            </b-button>
                            <b-card v-if="showStackTrace">
                                {{ errorDetailMessage }}
                            </b-card>
                        </b-alert>
                        <b-form @submit="onSubmit($event, customerForm, 'bv-modal-customer')">
                            <b-form-group label="Name:">
                                <b-form-input v-model="customerForm.name"/>
                            </b-form-group>
                            <b-form-group label="Address:">
                                <b-form-input v-model="customerForm.address"/>
                            </b-form-group>
                            <b-form-group label="Contact:">
                                <b-form-input v-model="customerForm.contact"/>
                            </b-form-group>
                            <b-form-group label="Tel:">
                                <b-form-input v-model="customerForm.telephone"/>
                            </b-form-group>
                            <b-form-group label="Terms:">
                                <b-form-input v-model="customerForm.terms"/>
                            </b-form-group>
                            <b-button type="submit" variant="primary">Submit</b-button>
                            <b-form-input v-model="customerForm.table" value="Customer" style="display:none;"/>
                            <b-form-input v-model="customerForm.id" style="display:none;"/>
                            <b-form-input v-model="customerForm.revision" style="display:none;"/>
                        </b-form>
                    </b-modal>
                    <b-table  ref="customerTable" bordered striped hover sticky-header :items="customerList" :fields="customerFields"
                             :busy="isBusy" @row-dblclicked="edit" :tbody-transition-props="transProps">
                        <template #table-busy>
                            <div class="text-center text-danger my-2">
                                <b-spinner class="align-middle"></b-spinner>
                                <strong>Loading...</strong>
                            </div>
                        </template>
                        <template #cell(edit)="row">
                            <b>{{ row.index + 1 }}</b>
                            <b-button size="sm" @click="edit(row.item, customerForm, 'bv-modal-customer')" class="mr-1">
                                Edit
                            </b-button>
                        </template>
                        <template #cell(name)="data">
                            {{ data.value }}
                        </template>
                        <template #cell(address)="data">
                            {{ data.value }}
                        </template>
                        <template #cell(telephone)="data">
                            {{ data.value }}
                        </template>
                        <template #cell(contact)="data">
                            {{ data.value }}
                        </template>
                        <template #cell(terms)="data">
                            {{ data.value }}
                        </template>
                    </b-table>
                </b-tab>
                <b-tab title="Order">
                    <b-button @click="newFormGeneric(orderForm, defaultOrderValues, 'bv-modal-order')">New</b-button>
                    <b-button @click="refresh('orderTable')">Refresh Table</b-button>
                    <b-modal ref="bv-modal-order" hide-footer>
                        <b-alert variant="danger" :show="showErrorAlert">{{ errorMessage }}</b-alert>
                        <b-alert variant="danger" :show="showErrorDetail">
                            <div>System Error</div>
                            <b-button :pressed.sync="showStackTrace" variant="primary">
                                {{ showStackTrace ? 'Hide' : 'Show' }} Error Details
                            </b-button>
                            <b-card v-if="showStackTrace">
                                {{ errorDetailMessage }}
                            </b-card>
                        </b-alert>
                        <b-form @submit="onSubmit($event, orderForm, 'bv-modal-order')">
                            <b-form-group label="Customer:">
                                <b-form-input v-model="orderForm.customerName" list="customerSelect"></b-form-input>
                            </b-form-group>
                            <b-form-group label="Order Date:">
                                <b-calendar v-model="orderForm.orderDate" locale="en-US"></b-calendar>
                            </b-form-group>
                            <b-button type="submit" variant="primary">Submit</b-button>
                        </b-form>
                    </b-modal>
                    <b-table  ref="orderTable" bordered striped hover sticky-header :items="orderList" :fields="orderFields"
                              :busy="isBusy" @row-dblclicked="edit" :tbody-transition-props="transProps">
                        <template #table-busy>
                            <div class="text-center text-danger my-2">
                                <b-spinner class="align-middle"></b-spinner>
                                <strong>Loading...</strong>
                            </div>
                        </template>
                        <template #cell(edit)="row">
                            <b>{{ row.index + 1 }}</b>
                            <b-button size="sm" @click="edit(row.item, orderForm, 'bv-modal-order')" class="mr-1">
                                Edit
                            </b-button>
                            <b-button size="sm" @click="info(row.item, row.index, $event.target)" class="mr-1">
                                Info modal
                            </b-button>
                            <b-button size="sm" @click="row.toggleDetails">
                                {{ row.detailsShowing ? 'Hide' : 'Show' }} Order Details
                            </b-button>
                        </template>
                        <template #cell(receiptNo)="data">
                            {{ data.value }}
                        </template>
                        <template #cell(customerName)="data">
                            {{ data.value }}
                        </template>
                        <template #cell(orderDate)="data">
                            {{ data.value }}
                        </template>
                        <template #cell(total)="data">
                            {{ data.value }}
                        </template>
                        <template #row-details="row">
                            <b-card>
                                <b-alert variant="danger" :show="showErrorAlert">{{ errorMessage }}</b-alert>
                                <b-alert variant="danger" :show="showErrorDetail">
                                    <div>System Error</div>
                                    <b-button :pressed.sync="showStackTrace" variant="primary">
                                        {{ showStackTrace ? 'Hide' : 'Show' }} Error Details
                                    </b-button>
                                    <b-card v-if="showStackTrace">
                                        {{ errorDetailMessage }}
                                    </b-card>
                                </b-alert>
                                <b-form @submit="onReletedSubmit($event, orderDetailForm, row.item)">
                                    <b-form-group label="Product:">
                                        <b-form-input v-model="orderDetailForm.productName" list="productSelect"></b-form-input>
                                    </b-form-group>
                                    <b-form-group label="Quantity:">
                                        <b-form-input v-model="orderDetailForm.quantity"/>
                                    </b-form-group>
                                    <b-form-checkbox
                                            id="checkbox-1"
                                            v-model="orderDetailForm.isPromo"
                                            name="checkbox-1"
                                            value="true"
                                            unchecked-value="false"
                                    >Promo</b-form-checkbox>
                                    <b-button type="submit" variant="primary">Add</b-button>
                                </b-form>
                                <b-table  ref="orderDetailProductTable" bordered striped hover sticky-header :items="row.item.products" :fields="orderDetailProductFields"
                                          :busy="isBusy" @row-dblclicked="edit" :tbody-transition-props="transProps">
                                    <template #table-busy>
                                        <div class="text-center text-danger my-2">
                                            <b-spinner class="align-middle"></b-spinner>
                                            <strong>Loading...</strong>
                                        </div>
                                    </template>
                                    <template #cell(quantity)="data">
                                        {{ data.value }}
                                    </template>
                                    <template #cell(name)="data">
                                        {{ data.value }}
                                    </template>
                                    <template #cell(price)="data">
                                        {{ data.value }}
                                    </template>
                                    <template #cell(defaultDiscount)="data">
                                        {{ data.value }}
                                    </template>
                                    <template #cell(total)="data">
                                        {{ data.value }}
                                    </template>
                                </b-table>
                                <b-table  ref="orderDetailPromoTable" bordered striped hover sticky-header :items="row.item.promo" :fields="orderDetailPromoFields"
                                          :busy="isBusy" @row-dblclicked="edit" :tbody-transition-props="transProps">
                                    <template #table-busy>
                                        <div class="text-center text-danger my-2">
                                            <b-spinner class="align-middle"></b-spinner>
                                            <strong>Loading...</strong>
                                        </div>
                                    </template>
                                    <template #cell(quantity)="data">
                                        {{ data.value }}
                                    </template>
                                    <template #cell(name)="data">
                                        {{ data.value }}
                                    </template>
                                </b-table>
                            </b-card>
                        </template>
                    </b-table>
                </b-tab>
                <b-tab title="Counter">
                    <b-button @click="newFormGeneric(counterForm, defaultCounterValues, 'bv-modal-counter')">New</b-button>
                    <b-button @click="refresh('counterTable')">Refresh Table</b-button>
                    <b-modal ref="bv-modal-counter" hide-footer>
                        <b-alert variant="danger" :show="showErrorAlert">{{ errorMessage }}</b-alert>
                        <b-alert variant="danger" :show="showErrorDetail">
                            <div>System Error</div>
                            <b-button :pressed.sync="showStackTrace" variant="primary">
                                {{ showStackTrace ? 'Hide' : 'Show' }} Error Details
                            </b-button>
                            <b-card v-if="showStackTrace">
                                {{ errorDetailMessage }}
                            </b-card>
                        </b-alert>
                        <b-form @submit="onSubmit($event, counterForm, 'bv-modal-counter')">
                            <b-form-group label="Name:">
                                <b-form-input v-model="counterForm.name"/>
                            </b-form-group>
                            <b-form-group label="Current Value:">
                                <b-form-input v-model="counterForm.value"/>
                            </b-form-group>
                            <b-button type="submit" variant="primary">Submit</b-button>
                        </b-form>
                    </b-modal>
                    <b-table  ref="counterTable" bordered striped hover sticky-header :items="counterList" :fields="counterFields"
                              :busy="isBusy" @row-dblclicked="edit" :tbody-transition-props="transProps">
                        <template #table-busy>
                            <div class="text-center text-danger my-2">
                                <b-spinner class="align-middle"></b-spinner>
                                <strong>Loading...</strong>
                            </div>
                        </template>
                        <template #cell(edit)="row">
                            <b>{{ row.index + 1 }}</b>
                            <b-button size="sm" @click="edit(row.item, counterForm, 'bv-modal-counter')" class="mr-1">
                                Edit
                            </b-button>
                        </template>
                        <template #cell(name)="data">
                            {{ data.value }}
                        </template>
                        <template #cell(value)="data">
                            {{ data.value }}
                        </template>
                    </b-table>
                </b-tab>
                <b-tab title="Product">
                    <b-button @click="newFormGeneric(productForm, defaultProductValues, 'bv-modal-product')">New</b-button>
                    <b-button @click="refresh('productTable')">Refresh Table</b-button>
                    <b-modal ref="bv-modal-product" hide-footer>
                        <b-alert variant="danger" :show="showErrorAlert">{{ errorMessage }}</b-alert>
                        <b-alert variant="danger" :show="showErrorDetail">
                            <div>System Error</div>
                            <b-button :pressed.sync="showStackTrace" variant="primary">
                                {{ showStackTrace ? 'Hide' : 'Show' }} Error Details
                            </b-button>
                            <b-card v-if="showStackTrace">
                                {{ errorDetailMessage }}
                            </b-card>
                        </b-alert>
                        <b-form @submit="onSubmit($event, productForm, 'bv-modal-product')">
                            <b-form-group label="Name:">
                                <b-form-input v-model="productForm.name"/>
                            </b-form-group>
                            <b-form-group label="Price:">
                                <b-form-input v-model="productForm.price"/>
                            </b-form-group>
                            <b-form-group label="Default Discount:">
                                <b-form-input v-model="productForm.defaultDiscount"/>
                            </b-form-group>
                            <b-button type="submit" variant="primary">Submit</b-button>
                        </b-form>
                    </b-modal>
                    <b-table  ref="productTable" bordered striped hover sticky-header :items="productList" :fields="productFields"
                              :busy="isBusy" @row-dblclicked="edit" :tbody-transition-props="transProps">
                        <template #table-busy>
                            <div class="text-center text-danger my-2">
                                <b-spinner class="align-middle"></b-spinner>
                                <strong>Loading...</strong>
                            </div>
                        </template>
                        <template #cell(edit)="row">
                            <b>{{ row.index + 1 }}</b>
                            <b-button size="sm" @click="edit(row.item, productForm, 'bv-modal-product')" class="mr-1">
                                Edit
                            </b-button>
                        </template>
                        <template #cell(name)="data">
                            {{ data.value }}
                        </template>
                        <template #cell(price)="data">
                            {{ data.value }}
                        </template>
                        <template #cell(defaultDiscount)="data">
                            {{ data.value }}
                        </template>
                    </b-table>
                </b-tab>
                <b-tab title="Payment"><b-card-text>Tab contents 4</b-card-text></b-tab>
                <b-tab title="Agent"><b-card-text>Tab contents 6</b-card-text></b-tab>
                <b-tab title="Category"><b-card-text>Tab contents 6</b-card-text></b-tab>
            </b-tabs>
        </b-card>
    </div>

    <!-- Add Vue and Bootstrap-Vue JS just before the closing </body> tag -->
    <script src="https://unpkg.com/vue/dist/vue.min.js"></script>
    <script src="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.min.js"></script>

    <!-- axios -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script>
    var app = new Vue({
      el: '#app',
      data: {
        isBusy: false,
        transProps: {
          name: 'flip-list'
        },
        dismissSecs: 5,
        dismissCountDown: 0,
        showErrorAlert: false,
        showStackTrace: false,
        errorMessage: '',
        showErrorDetail: false,
        errorDetailMessage: '',
        selectedItem: {},
        allItems: [],
        customerDataList: [],
        productDataList: [],
        infoModal: {
          id: 'info-modal',
          title: '',
          content: ''
        },
        defaultCustomerValues: {
          name: '',
          address: '',
          telephone: '',
          contact: '',
          terms: '60',
        },
        customerForm: {
          name: '',
          address: '',
          telephone: '',
          contact: '',
          terms: '',
          table: 'Customer',
          id: '',
          revision: ''
        },
        defaultProductValues: {
          name: '',
          price: '',
          defaultDiscount: 'NET',
        },
        productForm: {
          name: '',
          price: '',
          defaultDiscount: '',
          table: 'Product',
          id: '',
          revision: ''
        },
        defaultCounterValues: {
          name: '',
          value: ''
        },
        counterForm: {
          name: '',
          value: '',
          table: 'Counter',
          id: '',
          revision: ''
        },
        defaultOrderValues: {
          customerName: '',
          orderDate: ''
        },
        orderForm: {
          customerName: '',
          orderDate: '',
          table: 'Order',
          id: '',
          revision: ''
        },
        defaultOrderDetailValues: {
          productName: '',
          quantity: '',
          isPromo: 'false'
        },
        orderDetailForm: {
          productName: '',
          quantity: '',
          isPromo: '',
          table: 'Order',
          method: 'addProductRecord',
          id: '',
          revision: ''
        },
        customerFields: [{
            key: 'edit',
            label: 'Action'
          },
          {
            key: 'name',
            sortable: true
          },
          {
            key: 'address'
          },
          {
            key: 'contact',
            label: 'Contact Person'
          },
          {
            key: 'telephone',
            label: 'Tel Number'
          },
          {
            key: 'terms'
          }
        ],
        productFields: [{
            key: 'edit',
            label: 'Action'
          },
          {
            key: 'name',
            sortable: true
          },
          {
            key: 'price'
          },
          {
            key: 'defaultDiscount'
          }
        ],
        counterFields: [{
            key: 'edit',
            label: 'Action'
          },
          {
            key: 'name',
            sortable: true
          },
          {
            key: 'value'
          }
        ],
        orderFields: [{
            key: 'edit',
            label: 'Action'
          },
          {
            key: 'receiptNo'
          },
          {
            key: 'customerName',
            sortable: true
          },
          {
            key: 'orderDate'
          },
          {
            key: 'total'
          }
        ],
        orderDetailProductFields: [
          {
            key: 'quantity',
          },
          {
            key: 'name',
            sortable: true
          },
          {
            key: 'price'
          },
          {
            key: 'discount'
          },
          {
            key: 'total'
          }
        ],
        orderDetailPromoFields: [
          {
            key: 'quantity',
          },
          {
            key: 'name',
            sortable: true
          }
        ]
      },
      methods: {
        countDownChanged(dismissCountDown) {
          this.dismissCountDown = dismissCountDown;
        },
        showSuccessMessage() {
          this.dismissCountDown = this.dismissSecs;
        },
        refresh(refId) {
          this.$refs[refId].refresh();
        },
        resetError() {
          this.showErrorAlert = false;
          this.showErrorDetail = false;
          this.showStackTrace = false;
        },
        newFormGeneric(form, defaultValues, refId) {
          Object.assign(form, defaultValues);
          console.log("Form:");
          console.log(form);
          console.log("Default:");
          console.log(defaultValues);
          form.id = '';
          form.revision = '';
          console.log("REF_ID:" + refId);
          this.resetError();
          this.$refs[refId].show();
        },
        edit(item, editForm, refId) {
          this.selectedItem = item;
          Object.keys(editForm).forEach((key) => {
            if (key != 'table') {
              editForm[key] = item[key];
            }
          });
          console.log(editForm);
          this.resetError();
          this.$refs[refId].show();
        },
        getData(ctx, callback, type) {
          this.isBusy = true;
          console.log("Loading..."+ type);
          axios.get('/list?table=' + type)
            .then((response) => {
              this.isBusy = false;
              console.log(response);
              this.allItems = response.data;
              callback(response.data);
            })
            .catch((error) => {
              this.isBusy = false;
              console.log(error);
              callback([]);
            });
        },
        getDataSelect(type) {
          console.log("Loading Select..."+ type);
          axios.get('/list?table=' + type)
            .then((response) => {
              if(type == 'Customer'){
                this.customerDataList = response.data;
                console.log(this.customerDataList);
              }
              if(type == 'Product'){
                this.productDataList = response.data;
                console.log(this.productDataList);
              }
            })
            .catch((error) => {
              console.log(error);
            });
        },
        customerList(ctx, callback) {
          this.getData(ctx, callback, 'Customer');
        },
        productList(ctx, callback) {
          this.getData(ctx, callback, 'Product');
        },
        counterList(ctx, callback) {
          this.getData(ctx, callback, 'Counter');
        },
        orderList(ctx, callback) {
          this.getData(ctx, callback, 'Order');
        },
        info(item, index, button) {
            this.infoModal.title = `Row index: ${index}`
            this.infoModal.content = JSON.stringify(item, null, 2)
            this.$root.$emit('bv::show::modal', this.infoModal.id, button)
        },
        resetInfoModal() {
            this.infoModal.title = ''
            this.infoModal.content = ''
        },
        onReletedSubmit(event, submitForm, item) {
          event.preventDefault();
          this.selectedItem = item;
          submitForm.id = item.id;
          submitForm.revision = item.revision;
          this.onSubmit(event, submitForm, null);
        },
        onSubmit(event, submitForm, refId) {
          event.preventDefault();
          console.log('Submit');
          console.log(submitForm);
          var id = submitForm.id;
          axios.post(
              "/saveToDb",
              submitForm
            )
            .then(response => {
              console.log(response);
              console.log(response.data.error);
              console.log(response.data.stackTrace);
              var error = response.data.error;
              if (error.length > 0) {
                console.log('show error message');
                this.resetError();
                this.showErrorAlert = true;
                this.errorMessage = error.toString();
                if (response.data.revisionError) {
                  console.log('revision Error');
                  const {
                    attachments,
                    narrative,
                    ...copyForm
                  } = response.data.result;
                  Object.assign(this.customerForm, copyForm);
                }
              } else {
                var stackTrace = response.data.stackTrace;
                if (!stackTrace || stackTrace.length == 0) {
                  if(refId){
                    this.$refs[refId].hide();
                  }
                  console.log("ID:" + id);
                  if (!id || id.length == 0) {
                    console.log('push to table');
                    //this.$refs.customerTable.items.push(response.data.result);
                    //this.refresh('customerTable');
                  } else {
                    console.log('write to vue table');
                    Object.assign(this.selectedItem, response.data.result);
                  }
                  this.showSuccessMessage();
                } else {
                  console.log('show stacktrace');
                  this.resetError();
                  this.showErrorDetail = true;
                  this.errorDetailMessage = stackTrace;
                }
              }
            })
            .catch(error => {
              console.log(error);
              this.resetError();
              this.showErrorAlert = true;
              this.errorMessage = 'Connection Error';
            });
        }
      },
      created(){
        this.getDataSelect('Customer');
        this.getDataSelect('Product');
      }
    });
    </script>
</body>
</html>